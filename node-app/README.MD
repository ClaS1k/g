# Документация микросервиса для управления клиентом через [Socket.IO](http://socket.io/)

## Введение

Этот микросервис разработан для обеспечения управления клиентом через протокол [Socket.IO](http://socket.io/). Он предоставляет API для установки и завершения сеансов, а также для тарификации клиентских сеансов. Микросервис использует базу данных для хранения информации о подключенных хостах и текущих сессиях.

Документация по клинеской части https://socket.io/docs/v4/client-api/

## Функциональность

### Управление сеансами

- **start_session**: Запускает новый сеанс для клиента с помощью JWT-токена аутентификации и уникального идентификатора хоста.
- **end_session**: Завершает текущий активный сеанс клиента.

### Тарификация

- **calculatePricePerSecond**: Вычисляет текущую стоимость использования сеанса на основе активной тарифной схемы.
- **doTarification**: Вычитает стоимость сеанса из счета клиента по истечении интервала тарификации.

## Конфигурация

### Переменные окружения

- **PORT**: Порт, на котором будет запущен микросервис. По умолчанию 8766.
- **SECRET_KEY**: Секретный ключ для подписи и проверки JWT-токенов. Должен совпадать с ключом на бэкенде. В .env файле на докер он как раз общий.
- **TARIFICATION_INTERVAL_SEC**: Интервал (в секундах) тарификации. По умолчанию 1 секунда.

## API

### События клиента

При старте клиента (shell) необходимо инициализировать соединение следующим образом:

```jsx
socket = io(`https://biome.metagaming.ru`, {
      'reconnection delay':5,
      'reopen delay': 1,
      'force new connection': false,
      transports: ['websocket'],
      query: {
        identifier: identifier
      }
    });
    socket.on('connect', () => {
      # дальнейшая работа
    });
```

где identifier - mac адрес компьютера

- **start_session**: Событие для начала нового сеанса. В сообщении передается токен, который отдал бэкенд после авторизации пользователя

Пример: 

```jsx
socket.emit('start_session', valid_token);
```

- **end_session**: Событие для завершения текущего сеанса клиента.
- **disconnect**: Событие отключения клиента.

### События сервера

- **host_online**: Событие отправляется после подключения компа. передается json, в котором поле status либо online, либо not_found, если mac некорректный, после которого сервер автоматически закрывает соединение
- **invalid_token**: Событие отправляется, если на start_session предоставленный токен JWT недействителен.
- **session_started**: Событие отправляется при успешном запуске нового сеанса. передается json в котором есть session_id и player_id
- **session_not_started**: Событие отправляется, если не удалось запустить сеанс, ошибка на сервере
- **server_message**: Событие отправляется с информацией о тарификации или других событиях сервера. передается json формата

```
		{
        balance: 123.22,
        mode: 'product',
        product_id: product.product_id,
        remaining_time: 12312,
        action: 'product_update'
    }
```

если происходит списание с пакета минут

```jsx
   {
        balance: 123.12,
        mode: 'balance',
        action: 'balance_update'
   }
```

Если происходит списание с баланса

```jsx
   {
        balance: 0.0,
        mode: 'balance',
        action: 'disconnect'
   }
```

Если закончились деньги и нет активного пакета

### При получении action: 'disconnect' необходимо выполнить на клиенте ивент **end_session**

- **no_session**: Событие отправляется, если нет активного сеанса для завершения.
- **session_ended**: Событие отправляется после завершения сеанса.

## Зависимости

- **[socket.io](http://socket.io/)**: Для управления сокетами и обмена данными между клиентом и сервером.
- **jsonwebtoken**: Для создания и проверки JWT-токенов.
- **dotenv**: Для загрузки переменных окружения из файла .env.
- **uuid**: Для генерации уникальных идентификаторов сеансов.